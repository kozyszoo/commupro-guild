# Discord ã«ã‚ƒã‚“ã“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ãƒœãƒƒãƒˆ - GCP Docker Compose ç”¨ Cloud Build è¨­å®š
# Compute Engine ä¸Šã® Docker Compose ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç”¨

steps:
  # ã¿ã‚„ã«ã‚ƒã‚“ãƒœãƒƒãƒˆã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-f', 'Dockerfile.single',
      '-t', 'gcr.io/$PROJECT_ID/discord-nyanco-agent-miya:$BUILD_ID',
      '-t', 'gcr.io/$PROJECT_ID/discord-nyanco-agent-miya:latest',
      '--build-arg', 'BOT_CHARACTER=miya',
      '.'
    ]
    id: 'build-miya'

  # ã‚¤ãƒ´ã«ã‚ƒã‚“ãƒœãƒƒãƒˆã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build', 
      '-f', 'Dockerfile.single',
      '-t', 'gcr.io/$PROJECT_ID/discord-nyanco-agent-eve:$BUILD_ID',
      '-t', 'gcr.io/$PROJECT_ID/discord-nyanco-agent-eve:latest',
      '--build-arg', 'BOT_CHARACTER=eve',
      '.'
    ]
    id: 'build-eve'

  # ã¿ã‚„ã«ã‚ƒã‚“ãƒœãƒƒãƒˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Container Registryã«ãƒ—ãƒƒã‚·ãƒ¥
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/discord-nyanco-agent-miya:$BUILD_ID']
    waitFor: ['build-miya']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/discord-nyanco-agent-miya:latest']
    waitFor: ['build-miya']

  # ã‚¤ãƒ´ã«ã‚ƒã‚“ãƒœãƒƒãƒˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Container Registryã«ãƒ—ãƒƒã‚·ãƒ¥
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/discord-nyanco-agent-eve:$BUILD_ID']
    waitFor: ['build-eve']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/discord-nyanco-agent-eve:latest']
    waitFor: ['build-eve']

  # Compute Engine ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if gcloud compute instances describe nyanco-bot-compose --zone=asia-northeast1-a > /dev/null 2>&1; then
          echo "âœ… Instance exists, proceeding with deployment"
        else
          echo "âŒ Instance does not exist. Please run: ./deploy_gcp_compose.sh create"
          exit 1
        fi
    id: 'check-instance'

  # Compute Engine ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§Docker Composeã‚’æ›´æ–°
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«é€ä¿¡
        gcloud compute scp docker-compose.gcp.yml nyanco-bot-compose:~/docker-compose.yml --zone=asia-northeast1-a
        gcloud compute scp nginx.conf nyanco-bot-compose:~/nginx.conf --zone=asia-northeast1-a
        
        # æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«
        gcloud compute ssh nyanco-bot-compose --zone=asia-northeast1-a --command="docker pull gcr.io/$PROJECT_ID/discord-nyanco-agent-miya:latest"
        gcloud compute ssh nyanco-bot-compose --zone=asia-northeast1-a --command="docker pull gcr.io/$PROJECT_ID/discord-nyanco-agent-eve:latest"
        
        # Docker Composeã‚’å†èµ·å‹•
        gcloud compute ssh nyanco-bot-compose --zone=asia-northeast1-a --command="cd ~ && docker-compose down"
        gcloud compute ssh nyanco-bot-compose --zone=asia-northeast1-a --command="cd ~ && docker-compose up -d"
        
        echo "âœ… Deployment completed successfully"
    waitFor: ['check-instance']

  # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # å¤–éƒ¨IPã‚’å–å¾—
        EXTERNAL_IP=$(gcloud compute instances describe nyanco-bot-compose --zone=asia-northeast1-a --format="value(networkInterfaces[0].accessConfigs[0].natIP)")
        
        echo "ğŸŒ External IP: $EXTERNAL_IP"
        echo "ğŸ“ Health Check URLs:"
        echo "  - Overall: http://$EXTERNAL_IP/health"
        echo "  - Miya Bot: http://$EXTERNAL_IP/miya/health"
        echo "  - Eve Bot: http://$EXTERNAL_IP/eve/health"
        
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        sleep 30  # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ã‚’å¾…æ©Ÿ
        
        echo "ğŸ” Performing health checks..."
        if curl -f "http://$EXTERNAL_IP/health" > /dev/null 2>&1; then
          echo "âœ… Overall health check passed"
        else
          echo "âŒ Overall health check failed"
        fi

# ãƒ“ãƒ«ãƒ‰è¨­å®š
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  diskSizeGb: 100

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ30åˆ†ï¼‰
timeout: '1800s'

# ç½®æ›å¤‰æ•°
substitutions:
  _INSTANCE_NAME: 'nyanco-bot-compose'
  _ZONE: 'asia-northeast1-a'