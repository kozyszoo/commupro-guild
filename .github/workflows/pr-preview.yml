name: PR Preview

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18'

jobs:
  # PRæƒ…å ±ã®ç¢ºèª
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    
    steps:
    - name: PRæƒ…å ±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.payload.pull_request.number;
          const pr_title = context.payload.pull_request.title;
          const pr_author = context.payload.pull_request.user.login;
          const pr_url = context.payload.pull_request.html_url;
          
          const comment = `## ğŸ” PR Preview Bot
          
          **PRæƒ…å ±:**
          - ã‚¿ã‚¤ãƒˆãƒ«: ${pr_title}
          - ä½œæˆè€…: @${pr_author}
          - PRç•ªå·: #${pr_number}
          
          **å®Ÿè¡Œä¸­ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
          - âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          - âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          - âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæº–å‚™
          
          è©³ç´°ã¯[Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã§ç¢ºèªã§ãã¾ã™ã€‚
          `;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: pr_number,
            body: comment
          });

  # Firebase Preview ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Firebase Functions dependencies
      run: |
        cd functions
        npm ci
        
    - name: Build project
      run: npm run build
      
    - name: Build Firebase Functions
      run: |
        cd functions
        npm run build
        
    - name: Deploy to Firebase Preview
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
      id: firebase-deploy
      
    - name: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.payload.pull_request.number;
          const preview_url = '${{ steps.firebase-deploy.outputs.details_url }}';
          const hosting_url = '${{ steps.firebase-deploy.outputs.hosting_url }}';
          
          const comment = `## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
          
          **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL:**
          - ğŸŒ [ãƒ©ã‚¤ãƒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼](${hosting_url})
          - ğŸ“Š [è©³ç´°æƒ…å ±](${preview_url})
          
          **ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:**
          - ã‚³ãƒŸãƒƒãƒˆ: \`${{ github.sha }}\`
          - ãƒ–ãƒ©ãƒ³ãƒ: \`${{ github.head_ref }}\`
          - å®Ÿè¡Œæ™‚é–“: $(date -u)
          
          ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯24æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
          `;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: pr_number,
            body: comment
          });

  # Lighthouse ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  lighthouse-test:
    name: Lighthouse Performance Test
    runs-on: ubuntu-latest
    needs: deploy-preview
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Wait for deployment
      run: sleep 30
      
    - name: Run Lighthouse
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          ${{ needs.deploy-preview.outputs.hosting_url }}
        uploadArtifacts: true
        temporaryPublicStorage: true
      id: lighthouse
      
    - name: Lighthouseãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.payload.pull_request.number;
          
          const comment = `## âš¡ Lighthouse ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
          
          **ãƒ†ã‚¹ãƒˆçµæœ:**
          - ğŸ“Š [è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ](${{ steps.lighthouse.outputs.manifest }})
          - âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã€SEOç­‰ã‚’ãƒã‚§ãƒƒã‚¯æ¸ˆã¿
          
          **æ³¨æ„:** ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¹ã‚³ã‚¢ãŒ90æœªæº€ã®å ´åˆã¯æœ€é©åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
          `;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: pr_number,
            body: comment
          });

  # ã‚³ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºåˆ†æ
  analyze-bundle:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build for analysis
      run: npm run build
      
    - name: Analyze bundle size
      uses: preactjs/compressed-size-action@v2
      with:
        repo-token: '${{ secrets.GITHUB_TOKEN }}'
        pattern: './dist/**/*.{js,css,html}'
        exclude: '{*.map,node_modules/**/*}'

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆPRå°‚ç”¨ï¼‰
  security-scan-pr:
    name: Security Scan (PR)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: javascript, python
        
    - name: Autobuild
      uses: github/codeql-action/autobuild@v2
      
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

  # PR ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  update-pr-status:
    name: Update PR Status
    runs-on: ubuntu-latest
    needs: [pr-info, deploy-preview, lighthouse-test, analyze-bundle, security-scan-pr]
    if: always()
    
    steps:
    - name: æˆåŠŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      if: needs.deploy-preview.result == 'success' && needs.lighthouse-test.result == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.payload.pull_request.number;
          
          const comment = `## âœ… PR ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™å®Œäº†
          
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:**
          - ğŸŸ¢ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤: æˆåŠŸ
          - ğŸŸ¢ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ: æˆåŠŸ  
          - ğŸŸ¢ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: æˆåŠŸ
          - ğŸŸ¢ ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æ: æˆåŠŸ
          
          ã“ã®PRã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ãªçŠ¶æ…‹ã§ã™ã€‚
          `;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: pr_number,
            body: comment
          });
          
    - name: å¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      if: needs.deploy-preview.result == 'failure' || needs.lighthouse-test.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.payload.pull_request.number;
          
          const comment = `## âŒ PR ãƒã‚§ãƒƒã‚¯å¤±æ•—
          
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:**
          - ${needs.deploy-preview.result == 'success' ? 'ğŸŸ¢' : 'ğŸ”´'} ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤: ${needs.deploy-preview.result}
          - ${needs.lighthouse-test.result == 'success' ? 'ğŸŸ¢' : 'ğŸ”´'} ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ: ${needs.lighthouse-test.result}
          - ${needs.security-scan-pr.result == 'success' ? 'ğŸŸ¢' : 'ğŸ”´'} ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: ${needs.security-scan-pr.result}
          
          è©³ç´°ã¯[Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚
          `;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: pr_number,
            body: comment
          });

outputs:
  hosting_url:
    description: 'Firebase Preview URL'
    value: ${{ jobs.deploy-preview.outputs.hosting_url }}