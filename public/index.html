<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Discord にゃんこエージェント 管理パネル</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v6.4.0/js/all.js"></script>
    <style>
      .collection-card { cursor: pointer; }
      .collection-detail { display: none; }
      .collection-card.active .collection-detail { display: block; }
      .dashboard-section { margin-bottom: 2rem; }
    </style>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <h1 class="title">
          Discord にゃんこエージェント
        </h1>
        <p class="subtitle">
          管理パネル <strong>ダッシュボード</strong>
        </p>
        <!-- ダッシュボードセクション -->
        <div id="dashboard">
          <div class="dashboard-section" id="dashboard-users"></div>
          <div class="dashboard-section" id="dashboard-guilds"></div>
          <div class="dashboard-section" id="dashboard-interactions"></div>
          <div class="dashboard-section" id="dashboard-podcasts"></div>
          <div class="dashboard-section" id="dashboard-events"></div>
          <div class="dashboard-section" id="dashboard-user-matches"></div>
        </div>
        <hr>
        <div class="columns is-multiline">
          <!-- コレクションカード一覧 -->
          <div class="column is-6" id="collection-users">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  1. Users
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> Discordサーバーの各ユーザー情報を管理。<br>
                  <strong>主な用途:</strong> 新規参加者の歓迎、非アクティブ検出、マッチング、エンゲージメント分析<br>
                  <strong>主フィールド:</strong> id, guildId, username, isActive, lastActivity, interests, engagementScore, preferences
                </div>
              </div>
            </div>
          </div>
          <div class="column is-6" id="collection-guilds">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  2. Guilds
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> Discordサーバー（Guild）の設定情報を管理。<br>
                  <strong>主な用途:</strong> ボット動作カスタマイズ、キャラクター設定、機能ON/OFF、チャンネル管理<br>
                  <strong>主フィールド:</strong> id, name, ownerId, botSettings, welcomeChannelId, podcastChannelId, analytics
                </div>
              </div>
            </div>
          </div>
          <div class="column is-6" id="collection-interactions">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  3. Interactions
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> ユーザーの全インタラクション（メッセージ・リアクション等）を記録。<br>
                  <strong>主な用途:</strong> 関心分析、エンゲージメント測定、トレンド検出、ボット効果測定<br>
                  <strong>主フィールド:</strong> id, userId, guildId, type, channelId, content, timestamp, sentiment, keywords
                </div>
              </div>
            </div>
          </div>
          <div class="column is-6" id="collection-topics">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  4. Topics
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> 話題トピックの管理と人気・トレンドスコア算出。<br>
                  <strong>主な用途:</strong> コンテンツ推薦、ポッドキャスト選定、マッチング、トレンド分析<br>
                  <strong>主フィールド:</strong> id, guildId, name, keywords, popularity, trendScore, relatedTopics
                </div>
              </div>
            </div>
          </div>
          <div class="column is-6" id="collection-podcasts">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  5. Podcasts
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> にゃんこキャラによるポッドキャスト内容・統計を保存。<br>
                  <strong>主な用途:</strong> コミュニティ情報配信、エンゲージメント向上、活動可視化<br>
                  <strong>主フィールド:</strong> id, guildId, title, content, topics, publishedAt, channelId, views, reactions
                </div>
              </div>
            </div>
          </div>
          <div class="column is-6" id="collection-user-matches">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  6. User Matches
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> ユーザー同士のマッチング情報を管理。<br>
                  <strong>主な用途:</strong> 紹介、ネットワーク形成、マッチング効果測定、孤立ユーザー発見<br>
                  <strong>主フィールド:</strong> id, guildId, user1Id, user2Id, commonInterests, matchScore, status, createdAt
                </div>
              </div>
            </div>
          </div>
          <div class="column is-6" id="collection-events">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  7. Events
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> サーバー内イベント情報・参加者を管理。<br>
                  <strong>主な用途:</strong> イベント管理、参加者追跡、効果測定、活性化<br>
                  <strong>主フィールド:</strong> id, guildId, title, description, startTime, endTime, channelId, attendees, metadata
                </div>
              </div>
            </div>
          </div>
          <div class="column is-6" id="collection-analytics">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  8. Analytics Sessions
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> 日次・週次・月次の活動統計データ。<br>
                  <strong>主な用途:</strong> ダッシュボード、トレンド分析、パフォーマンス測定、レポート生成<br>
                  <strong>主フィールド:</strong> id, guildId, date, activeUsers, messageCount, newMembers, topTopics, channelActivity
                </div>
              </div>
            </div>
          </div>
          <div class="column is-6" id="collection-bot-actions">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  9. Bot Actions
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> ボットが実行したアクション履歴と結果を記録。<br>
                  <strong>主な用途:</strong> 効果測定、履歴追跡、失敗分析、最適化<br>
                  <strong>主フィールド:</strong> id, guildId, userId, actionType, targetId, payload, timestamp, status, result
                </div>
              </div>
            </div>
          </div>
          <div class="column is-6" id="collection-admin-users">
            <div class="card collection-card">
              <header class="card-header">
                <p class="card-header-title">
                  10. Admin Users
                </p>
                <span class="icon card-toggle"><i class="fas fa-angle-down"></i></span>
              </header>
              <div class="card-content collection-detail">
                <div class="content">
                  <strong>概要:</strong> 管理権限ユーザー情報・権限設定を管理。<br>
                  <strong>主な用途:</strong> 管理画面アクセス制御、権限制限、監査ログ、セキュリティ管理<br>
                  <strong>主フィールド:</strong> uid, guildIds, email, role, createdAt, lastLogin, permissions
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="notification is-info mt-5">
          各コレクションカードをクリックすると詳細が展開されます。
        </div>
      </div>
    </section>
    <script>
      // ダッシュボード描画用
      async function loadDashboard() {
        // fetchでローカルjsonを取得
        const [users, guilds, interactions, podcasts, events, userMatches] = await Promise.all([
          fetch('/data/users.json').then(r => r.json()),
          fetch('/data/guilds.json').then(r => r.json()),
          fetch('/data/interactions.json').then(r => r.json()),
          fetch('/data/podcasts.json').then(r => r.json()),
          fetch('/data/events.json').then(r => r.json()),
          fetch('/data/user_matches.json').then(r => r.json()),
        ]);

        // ユーザー統計
        const userList = Object.values(users.users || {});
        const totalUsers = userList.length;
        const activeUsers = userList.filter(u => u.isActive).length;
        const avgEngagement = userList.length ? (userList.reduce((sum, u) => sum + (u.engagementScore || 0), 0) / userList.length).toFixed(1) : '-';
        document.getElementById('dashboard-users').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">👤 ユーザー統計</p></header>
            <div class="card-content">
              <div class="content">
                総ユーザー数: <strong>${totalUsers}</strong> ／ アクティブ: <strong>${activeUsers}</strong> ／ 平均エンゲージメント: <strong>${avgEngagement}</strong><br>
                <table class="table is-fullwidth is-striped is-narrow mt-2">
                  <thead><tr><th>ユーザー名</th><th>表示名</th><th>アクティブ</th><th>スコア</th><th>関心</th></tr></thead>
                  <tbody>
                    ${userList.map(u => `<tr><td>${u.username}</td><td>${u.displayName||''}</td><td>${u.isActive ? '✅' : '❌'}</td><td>${u.engagementScore||'-'}</td><td>${(u.interests||[]).join(', ')}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // ギルド統計
        const guildList = Object.values(guilds.guilds || {});
        document.getElementById('dashboard-guilds').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">🛡️ サーバー（ギルド）情報</p></header>
            <div class="card-content">
              <div class="content">
                ${guildList.map(g => `
                  <strong>${g.name}</strong>（ID: ${g.id}）<br>
                  メンバー数: <strong>${g.analytics?.totalMembers||'-'}</strong> ／ アクティブ: <strong>${g.analytics?.activeMembers||'-'}</strong> ／ 平均エンゲージメント: <strong>${g.analytics?.averageEngagement||'-'}</strong><br>
                  トップチャンネル: ${(g.analytics?.topChannels||[]).join(', ')}<br>
                  <span class="tag is-info">Bot設定: ${g.botSettings?.matchingEnabled ? 'マッチング有効' : '無効'}</span>
                  <hr>
                `).join('')}
              </div>
            </div>
          </div>
        `;

        // インタラクション統計
        const interactionList = Object.values(interactions.interactions || {});
        const totalInteractions = interactionList.length;
        const messageCount = interactionList.filter(i => i.type === 'message').length;
        const reactionCount = interactionList.filter(i => i.type === 'reaction').length;
        const botCount = interactionList.filter(i => i.type === 'bot_interaction').length;
        document.getElementById('dashboard-interactions').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">💬 インタラクション統計</p></header>
            <div class="card-content">
              <div class="content">
                総インタラクション: <strong>${totalInteractions}</strong> ／ メッセージ: <strong>${messageCount}</strong> ／ リアクション: <strong>${reactionCount}</strong> ／ ボット対話: <strong>${botCount}</strong><br>
                <table class="table is-fullwidth is-striped is-narrow mt-2">
                  <thead><tr><th>タイプ</th><th>ユーザー</th><th>内容</th><th>日時</th></tr></thead>
                  <tbody>
                    ${interactionList.slice(0,5).map(i => `<tr><td>${i.type}</td><td>${i.userId}</td><td>${i.content ? i.content.substring(0,30) : '-'}</td><td>${i.timestamp?.replace('T',' ').replace('Z','')}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // ポッドキャスト
        const podcastList = Object.values(podcasts.podcasts || {});
        document.getElementById('dashboard-podcasts').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">🎙️ 最新ポッドキャスト</p></header>
            <div class="card-content">
              <div class="content">
                ${podcastList.length ? podcastList.map(p => `
                  <strong>${p.title}</strong>（${p.publishedAt?.replace('T',' ').replace('Z','')}）<br>
                  閲覧数: <strong>${p.views||0}</strong> ／ リアクション: ${p.reactions?.map(r => `${r.emoji}×${r.count}`).join(' ')}<br>
                  <span class="is-size-7">${p.content.substring(0,80)}...</span>
                  <hr>
                `).join('') : 'データなし'}
              </div>
            </div>
          </div>
        `;

        // イベント
        const eventList = Object.values(events.events || {});
        document.getElementById('dashboard-events').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">📅 最新イベント</p></header>
            <div class="card-content">
              <div class="content">
                ${eventList.length ? eventList.map(e => `
                  <strong>${e.title}</strong>（${e.startTime?.replace('T',' ').replace('Z','')}）<br>
                  参加予定: <strong>${(e.attendees||[]).length}</strong>人 ／ チャンネル: ${e.channelId}<br>
                  <span class="is-size-7">${e.description?.substring(0,60)}...</span>
                  <hr>
                `).join('') : 'データなし'}
              </div>
            </div>
          </div>
        `;

        // ユーザーマッチング
        const matchList = Object.values(userMatches.user_matches || {});
        document.getElementById('dashboard-user-matches').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">🤝 ユーザーマッチング状況</p></header>
            <div class="card-content">
              <div class="content">
                総マッチ数: <strong>${matchList.length}</strong><br>
                <table class="table is-fullwidth is-striped is-narrow mt-2">
                  <thead><tr><th>ユーザー1</th><th>ユーザー2</th><th>共通関心</th><th>スコア</th><th>状態</th></tr></thead>
                  <tbody>
                    ${matchList.map(m => `<tr><td>${m.user1Id}</td><td>${m.user2Id}</td><td>${(m.commonInterests||[]).join(', ')}</td><td>${m.matchScore}</td><td>${m.status}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }
      loadDashboard();

      // カードのクリックで詳細をトグル
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.collection-card').forEach(function(card) {
          card.addEventListener('click', function() {
            card.classList.toggle('active');
            const icon = card.querySelector('.card-toggle i');
            if (card.classList.contains('active')) {
              icon.classList.remove('fa-angle-down');
              icon.classList.add('fa-angle-up');
            } else {
              icon.classList.remove('fa-angle-up');
              icon.classList.add('fa-angle-down');
            }
          });
        });
      });
    </script>
    <script src="/__/firebase/9.22.0/firebase-app-compat.js"></script>
    <script src="/__/firebase/9.22.0/firebase-auth-compat.js"></script>
    <script src="/__/firebase/9.22.0/firebase-firestore-compat.js"></script>
    <script src="/__/firebase/init.js"></script>
  </body>
</html>
