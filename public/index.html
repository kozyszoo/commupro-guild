<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Discord ã«ã‚ƒã‚“ã“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ç®¡ç†ãƒ‘ãƒãƒ«</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v6.4.0/js/all.js"></script>
    <style>
      .dashboard-section { margin-bottom: 2rem; }
    </style>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <h1 class="title">
          Discord ã«ã‚ƒã‚“ã“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        </h1>
        <p class="subtitle">
          ç®¡ç†ãƒ‘ãƒãƒ« <strong>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</strong>
        </p>
        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="dashboard">
          <div class="dashboard-section" id="dashboard-users"></div>
          <div class="dashboard-section" id="dashboard-guilds"></div>
          <div class="dashboard-section" id="dashboard-interactions"></div>
          <div class="dashboard-section" id="dashboard-podcasts"></div>
          <div class="dashboard-section" id="dashboard-events"></div>
          <div class="dashboard-section" id="dashboard-user-matches"></div>
          <div class="dashboard-section" id="dashboard-admin-users"></div>
          <div class="dashboard-section" id="dashboard-bot-actions"></div>
          <div class="dashboard-section" id="dashboard-analytics-sessions"></div>
        </div>
      </div>
    </section>
    <script>
      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”»ç”¨
      async function loadDashboard() {
        // fetchã§ãƒ­ãƒ¼ã‚«ãƒ«jsonã‚’å–å¾—
        const [users, guilds, interactions, podcasts, events, userMatches, adminUsers, botActions, analyticsSessions] = await Promise.all([
          fetch('/data/users.json').then(r => r.json()),
          fetch('/data/guilds.json').then(r => r.json()),
          fetch('/data/interactions.json').then(r => r.json()),
          fetch('/data/podcasts.json').then(r => r.json()),
          fetch('/data/events.json').then(r => r.json()),
          fetch('/data/user_matches.json').then(r => r.json()),
          fetch('/data/admin_users.json').then(r => r.json()),
          fetch('/data/bot_actions.json').then(r => r.json()),
          fetch('/data/analytics_sessions.json').then(r => r.json()),
        ]);

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ
        const userList = Object.values(users.users || {});
        const totalUsers = userList.length;
        const activeUsers = userList.filter(u => u.isActive).length;
        const avgEngagement = userList.length ? (userList.reduce((sum, u) => sum + (u.engagementScore || 0), 0) / userList.length).toFixed(1) : '-';
        document.getElementById('dashboard-users').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ</p></header>
            <div class="card-content">
              <div class="content">
                ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: <strong>${totalUsers}</strong> ï¼ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: <strong>${activeUsers}</strong> ï¼ å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ: <strong>${avgEngagement}</strong><br>
                <table class="table is-fullwidth is-striped is-narrow mt-2">
                  <thead><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th><th>è¡¨ç¤ºå</th><th>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</th><th>ã‚¹ã‚³ã‚¢</th><th>é–¢å¿ƒ</th></tr></thead>
                  <tbody>
                    ${userList.map(u => `<tr><td>${u.username}</td><td>${u.displayName||''}</td><td>${u.isActive ? 'âœ…' : 'âŒ'}</td><td>${u.engagementScore||'-'}</td><td>${(u.interests||[]).join(', ')}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // ã‚®ãƒ«ãƒ‰çµ±è¨ˆ
        const guildList = Object.values(guilds.guilds || {});
        document.getElementById('dashboard-guilds').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">ğŸ›¡ï¸ ã‚µãƒ¼ãƒãƒ¼ï¼ˆã‚®ãƒ«ãƒ‰ï¼‰æƒ…å ±</p></header>
            <div class="card-content">
              <div class="content">
                ${guildList.map(g => `
                  <strong>${g.name}</strong>ï¼ˆID: ${g.id}ï¼‰<br>
                  ãƒ¡ãƒ³ãƒãƒ¼æ•°: <strong>${g.analytics?.totalMembers||'-'}</strong> ï¼ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: <strong>${g.analytics?.activeMembers||'-'}</strong> ï¼ å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ: <strong>${g.analytics?.averageEngagement||'-'}</strong><br>
                  ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ãƒãƒ«: ${(g.analytics?.topChannels||[]).join(', ')}<br>
                  <span class="tag is-info">Botè¨­å®š: ${g.botSettings?.matchingEnabled ? 'ãƒãƒƒãƒãƒ³ã‚°æœ‰åŠ¹' : 'ç„¡åŠ¹'}</span>
                  <hr>
                `).join('')}
              </div>
            </div>
          </div>
        `;

        // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆ
        const interactionList = Object.values(interactions.interactions || {});
        const totalInteractions = interactionList.length;
        const messageCount = interactionList.filter(i => i.type === 'message').length;
        const reactionCount = interactionList.filter(i => i.type === 'reaction').length;
        const botCount = interactionList.filter(i => i.type === 'bot_interaction').length;
        document.getElementById('dashboard-interactions').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">ğŸ’¬ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆ</p></header>
            <div class="card-content">
              <div class="content">
                ç·ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³: <strong>${totalInteractions}</strong> ï¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: <strong>${messageCount}</strong> ï¼ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³: <strong>${reactionCount}</strong> ï¼ ãƒœãƒƒãƒˆå¯¾è©±: <strong>${botCount}</strong><br>
                <table class="table is-fullwidth is-striped is-narrow mt-2">
                  <thead><tr><th>ã‚¿ã‚¤ãƒ—</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>å†…å®¹</th><th>æ—¥æ™‚</th></tr></thead>
                  <tbody>
                    ${interactionList.slice(0,5).map(i => `<tr><td>${i.type}</td><td>${i.userId}</td><td>${i.content ? i.content.substring(0,30) : '-'}</td><td>${i.timestamp?.replace('T',' ').replace('Z','')}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
        const podcastList = Object.values(podcasts.podcasts || {});
        document.getElementById('dashboard-podcasts').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">ğŸ™ï¸ æœ€æ–°ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ</p></header>
            <div class="card-content">
              <div class="content">
                ${podcastList.length ? podcastList.map(p => `
                  <strong>${p.title}</strong>ï¼ˆ${p.publishedAt?.replace('T',' ').replace('Z','')}ï¼‰<br>
                  é–²è¦§æ•°: <strong>${p.views||0}</strong> ï¼ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${p.reactions?.map(r => `${r.emoji}Ã—${r.count}`).join(' ')}<br>
                  <span class="is-size-7">${p.content.substring(0,80)}...</span>
                  <hr>
                `).join('') : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}
              </div>
            </div>
          </div>
        `;

        // ã‚¤ãƒ™ãƒ³ãƒˆ
        const eventList = Object.values(events.events || {});
        document.getElementById('dashboard-events').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">ğŸ“… æœ€æ–°ã‚¤ãƒ™ãƒ³ãƒˆ</p></header>
            <div class="card-content">
              <div class="content">
                ${eventList.length ? eventList.map(e => `
                  <strong>${e.title}</strong>ï¼ˆ${e.startTime?.replace('T',' ').replace('Z','')}ï¼‰<br>
                  å‚åŠ äºˆå®š: <strong>${(e.attendees||[]).length}</strong>äºº ï¼ ãƒãƒ£ãƒ³ãƒãƒ«: ${e.channelId}<br>
                  <span class="is-size-7">${e.description?.substring(0,60)}...</span>
                  <hr>
                `).join('') : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}
              </div>
            </div>
          </div>
        `;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒãƒ³ã‚°
        const matchList = Object.values(userMatches.user_matches || {});
        document.getElementById('dashboard-user-matches').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">ğŸ¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒãƒ³ã‚°çŠ¶æ³</p></header>
            <div class="card-content">
              <div class="content">
                ç·ãƒãƒƒãƒæ•°: <strong>${matchList.length}</strong><br>
                <table class="table is-fullwidth is-striped is-narrow mt-2">
                  <thead><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼1</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼2</th><th>å…±é€šé–¢å¿ƒ</th><th>ã‚¹ã‚³ã‚¢</th><th>çŠ¶æ…‹</th></tr></thead>
                  <tbody>
                    ${matchList.map(m => `<tr><td>${m.user1Id}</td><td>${m.user2Id}</td><td>${(m.commonInterests||[]).join(', ')}</td><td>${m.matchScore}</td><td>${m.status}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼
        const adminList = Object.values(adminUsers.admin_users || {});
        document.getElementById('dashboard-admin-users').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">ğŸ› ï¸ ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼</p></header>
            <div class="card-content">
              <div class="content">
                <table class="table is-fullwidth is-striped is-narrow mt-2">
                  <thead><tr><th>Email</th><th>ãƒ­ãƒ¼ãƒ«</th><th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th><th>æ¨©é™</th></tr></thead>
                  <tbody>
                    ${adminList.map(a => `<tr><td>${a.email}</td><td>${a.role}</td><td>${a.lastLogin?.replace('T',' ').replace('Z','')}</td><td>${Object.entries(a.permissions||{}).filter(([k,v])=>v).map(([k])=>k).join(', ')}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // ãƒœãƒƒãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        const botActionList = Object.values(botActions.bot_actions || {});
        document.getElementById('dashboard-bot-actions').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">ğŸ¤– ãƒœãƒƒãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´</p></header>
            <div class="card-content">
              <div class="content">
                <table class="table is-fullwidth is-striped is-narrow mt-2">
                  <thead><tr><th>ã‚¿ã‚¤ãƒ—</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>æ—¥æ™‚</th><th>çŠ¶æ…‹</th><th>çµæœ</th></tr></thead>
                  <tbody>
                    ${botActionList.map(b => `<tr><td>${b.actionType}</td><td>${b.userId}</td><td>${b.timestamp?.replace('T',' ').replace('Z','')}</td><td>${b.status}</td><td>${b.result ? Object.entries(b.result).map(([k,v])=>`${k}:${v}`).join(' / ') : '-'}</td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
        const analyticsList = Object.values(analyticsSessions.analytics_sessions || {});
        document.getElementById('dashboard-analytics-sessions').innerHTML = `
          <div class="card">
            <header class="card-header"><p class="card-header-title">ğŸ“Š æ—¥æ¬¡ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</p></header>
            <div class="card-content">
              <div class="content">
                ${analyticsList.length ? analyticsList.map(a => `
                  <strong>${a.date}</strong>ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ– <strong>${a.activeUsers}</strong>äºº ï¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ <strong>${a.messageCount}</strong> ï¼ æ–°è¦ <strong>${a.newMembers}</strong> ï¼ å†ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ <strong>${a.reengagements}</strong><br>
                  <span class="is-size-7">ãƒˆãƒƒãƒ—ãƒˆãƒ”ãƒƒã‚¯: ${Object.entries(a.topTopics||{}).map(([k,v])=>`${k}(${v})`).join(', ')}<br>ãƒãƒ£ãƒ³ãƒãƒ«æ´»å‹•: ${Object.entries(a.channelActivity||{}).map(([k,v])=>`${k}(${v})`).join(', ')}</span>
                  <hr>
                `).join('') : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}
              </div>
            </div>
          </div>
        `;
      }
      loadDashboard();
    </script>
    <script src="/__/firebase/9.22.0/firebase-app-compat.js"></script>
    <script src="/__/firebase/9.22.0/firebase-auth-compat.js"></script>
    <script src="/__/firebase/9.22.0/firebase-firestore-compat.js"></script>
    <script src="/__/firebase/init.js"></script>
  </body>
</html>
